<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <!-- https://stackoverflow.com/questions/69619035/error-with-permissions-policy-header-unrecognized-feature-interest-cohort -->
    <link rel="stylesheet" href="./main.css">
    <title>SwEmu</title>
  </head>
  <body class="disable-select">
    <div>
      <canvas class="disable-select" id="canvas_static" width="100vh" height="100vh"></canvas>
      <canvas class="disable-select" id="canvas_dynamic" width="100vh" height="100vh" style="background-color: black; border-radius: 10px;"></canvas>
    </div>
    <script type="module">
      import { CustomDraw } from "./CustomDraw.js";
      import { Point, Vector2D } from "./Geometry.js";
      import { MyMath } from "./MyMath.js";
      import { GamepadDummy } from "./GamepadDummy.js";
      import { setCookie, getCookie } from "./Cookies.js";
      // Import Games
      import { CoinCollect } from "./games/CoinCollect.js";
      import { PhysicTest } from "./games/PhysicTest.js";
      import { HighwayRun } from "./games/HighwayRun.js";
      import { Pong } from "./games/Pong.js";
      // Import SystemApplications
      import { HomeScreen, NewsApp, AddOnStore, Gallery, ControllerManager, Settings } from "./SystemApplications.js";

      // https://stackoverflow.com/questions/122102/what-is-the-most-efficient-way-to-deep-clone-an-object-in-javascript
      let clone = (obj) => {
        return JSON.parse(JSON.stringify(obj));
      }

      let swemu = {
        screen: {
          width: 630,
          height: 360,
          borderWidth: 50,
          borderHeight: 20,
        },
        joycon: {
          width: 130,
          height: 400,
        }
      };

      let canvas = {
        static: document.getElementById("canvas_static"),
        dynamic: document.getElementById("canvas_dynamic"),
      };
      let context = {
        static: canvas.static.getContext("2d"),
        dynamic: canvas.dynamic.getContext("2d"),
      };
      let draw = {
        static: new CustomDraw(canvas.static, context.static),
        dynamic: new CustomDraw(canvas.dynamic, context.dynamic),
      };

      // Static
      canvas.static.width = 2*(swemu.joycon.width + swemu.screen.borderWidth) + swemu.screen.width;
      canvas.static.height = swemu.joycon.height;

      canvas.static.style.position = "absolute";
      canvas.static.style.left = (window.innerWidth / 2) - (swemu.screen.width / 2) - (swemu.joycon.width + swemu.screen.borderWidth) + "px";
      canvas.static.style.top = (window.innerHeight / 2) - (swemu.screen.height / 2) - (swemu.screen.borderHeight) + "px";

      // Dynamic
      canvas.dynamic.width = swemu.screen.width;
      canvas.dynamic.height = swemu.screen.height;

      canvas.dynamic.style.position = "absolute";
      canvas.dynamic.style.left = (window.innerWidth / 2) - (swemu.screen.width / 2) + "px";
      canvas.dynamic.style.top = (window.innerHeight / 2) - (swemu.screen.height / 2)+ "px";

      let points = {
        zero: new Point(),

        blueJoyConStart: new Point(),
        blueJoyConMid: new Point(swemu.joycon.width / 2, 0),
        blueJoyConEnd: new Point(swemu.joycon.width, swemu.joycon.height),

        displayBorderStart: new Point(swemu.joycon.width, 0),
        displayBorderEnd: new Point(swemu.joycon.width, 0).add(
          new Point(swemu.screen.width, 0).add(
            new Point(swemu.screen.borderWidth, 0).multiply(2).add(
              new Point(0, canvas.static.height)
            )
          )
        ),

        redJoyConStart: new Point(swemu.joycon.width, 0).add(
          new Point(swemu.screen.width, 0).add(
            new Point(swemu.screen.borderWidth, 0).multiply(2)
          )
        ),
        redJoyConMid: new Point(swemu.joycon.width, 0).multiply(1.5).add(
          new Point(swemu.screen.width, 0).add(
            new Point(swemu.screen.borderWidth, 0).multiply(2).add(
              new Point(0, canvas.static.height)
            )
          )
        ),
        redJoyConEnd: new Point(swemu.joycon.width, 0).multiply(2).add(
          new Point(swemu.screen.width, 0).add(
            new Point(swemu.screen.borderWidth, 0).multiply(2).add(
              new Point(0, canvas.static.height)
            )
          )
        ),
      };

      let internals = {
        /*users: [
          {
            uid: "6468adbc-aa33-4884-99a4-a0eb4bc7e083",
            name: "User 0",
            icon: {
              background: 0,
            },
          },
        ],*/
        uid: null,
        users: [],
        applications: {
          system: {
            newsApp: NewsApp,
            addOnStore: AddOnStore,
            gallery: Gallery,
            controllerManager: ControllerManager,
            settings: Settings,
            homeScreen: HomeScreen,
          },
          external: {
            coinCollect: CoinCollect,
            // physicTest: PhysicTest,
            // highwayRun: HighwayRun,
            pong: Pong,
          }
        },
        settings: {
          debug: false,
        }
      }

      let gamepads = {
        player1: new GamepadDummy(),
        player2: new GamepadDummy(),
        player3: new GamepadDummy(),
        player4: new GamepadDummy()
      };

      let render = {
        deltaTime: Date.now(),
        now: Date.now(),
        input: { // Used for debugging, if verbose === true: print delay (in ms) between (mousedown or mouseup or mousemove) and finished render
          verbose: true,
          delay: 0, // debug output (01.05.2023 22:50 => ~10ms (before obstacles and coins))
          now: 0,
          updated: false,
        },
        delayed: {
          deltaTime: Date.now(),
          input: {
            delay: 0,
          },
        }
      }

      let generateUID = () => {
        let uid = "";
        for (let i=1; i<=8+4+4+4+12; i++) {
          uid += parseInt(Math.random() * 16).toString(16);
          if (i === 8 || i === 8+4 || i === 8+4+4 || i === 8+4+4+4) uid += "-";
        }
        return uid;
      }

      let renderSwitch = () => {
        // Blue JoyCon
        draw.static.setColor("00c3e3");
        draw.static.roundedRect(points.blueJoyConStart, points.blueJoyConEnd, 1);
        draw.static.rect(points.blueJoyConMid, points.blueJoyConEnd);

        // Display Border
        draw.static.setColor("414548");
        draw.static.rect(points.displayBorderStart, points.displayBorderEnd);

        // Red JoyCon
        draw.static.setColor("e60012");
        draw.static.roundedRect(points.redJoyConStart, points.redJoyConEnd, 1);
        draw.static.rect(points.redJoyConStart, points.redJoyConMid);
      }

      let gamepadHandler = (event, connecting) => {
        if (connecting)Â {
          let players = Object.entries(gamepads);
          for (let i=0; i<players.length; i++) {
            let [pname, _] = players[i];
            if (gamepads[pname].id !== -1) continue;
            gamepads[pname] = new GamepadDummy(event.gamepad.index);
            break;
          }
        } else {
          let players = Object.entries(gamepads);
          for (let i=0; i<players.length; i++) {
            let [pname, _] = players[i];
            if (gamepads[pname].id !== event.gamepad.index) continue;
            gamepads[pname].id = -1;
            break;
          }
        }
      }

      let getGamepadData = () => {
        if (render.input.verbose && !render.input.updated) {
          render.input.now = Date.now();
          render.input.updated = true;
        }

        let connectedGamepads = navigator.getGamepads();

        let players = Object.entries(gamepads);
        for (let i=0; i<players.length; i++) {
          let [_, player_gamepad] = players[i];
          if (player_gamepad.id === -1) continue;
          let gamepad = connectedGamepads[player_gamepad.id];

          player_gamepad.pressed.a = gamepad.buttons[0].pressed;
          player_gamepad.pressed.b = gamepad.buttons[1].pressed;
          player_gamepad.pressed.x = gamepad.buttons[2].pressed;
          player_gamepad.pressed.y = gamepad.buttons[3].pressed;
          player_gamepad.pressed.paused = gamepad.buttons[9].pressed;
          player_gamepad.pressed.dpad.up = gamepad.buttons[12].pressed;
          player_gamepad.pressed.dpad.down = gamepad.buttons[13].pressed;
          player_gamepad.pressed.dpad.left = gamepad.buttons[14].pressed;
          player_gamepad.pressed.dpad.right = gamepad.buttons[15].pressed;

          player_gamepad.trigger.left = 0;
          player_gamepad.trigger.right = 0;

          player_gamepad.joystick.left = new Vector2D(gamepad.axes[0], gamepad.axes[1]);
          // console.log([gamepad.axes[0], gamepad.axes[1]]); // [-0, -0]
          // console.log([player_gamepad.joystick.left.x, player_gamepad.joystick.left.y]); // [-0, -0]
          let ll = player_gamepad.joystick.left.length();
          // console.log(ll); // 0
          ll = MyMath.clamp(ll, 0, 1);
          // console.log(ll); // 0
          if (ll >= player_gamepad.joystick.deadzone) player_gamepad.joystick.used.left = true;
          else player_gamepad.joystick.used.left = false;
          player_gamepad.joystick.left.normalize().multiply(ll);
          // console.log([player_gamepad.joystick.left.x, player_gamepad.joystick.left.y]); // [NaN, NaN]

          player_gamepad.joystick.right = new Vector2D(gamepad.axes[2], gamepad.axes[3]);
          let rl = player_gamepad.joystick.right.length();
          rl = MyMath.clamp(rl, 0, 1);
          if (rl >= player_gamepad.joystick.deadzone) player_gamepad.joystick.used.right = true;
          else player_gamepad.joystick.used.right = false;
          player_gamepad.joystick.right.normalize().multiply(rl);
        }
      }
      let renderGamepad = () => {
        let joyStickRadius = swemu.joycon.width/5;
        let buttonRadius = swemu.joycon.width/10;
        let pressedShrinkRadius = 2.5;

        // Left JoyCon
        let joyStickCenterLeft = new Point((swemu.joycon.width/2), (swemu.joycon.height/4));
        let joyStickPositionLeft = new Point(joyStickRadius*0.8*gamepads.player1.joystick.left.x, joyStickRadius*0.8*gamepads.player1.joystick.left.y).add(joyStickCenterLeft);

        draw.static.setColor("00c3e3");
        draw.static.rect(new Point(-joyStickRadius*2, -joyStickRadius*2).add(joyStickCenterLeft), new Point(joyStickRadius*2, joyStickRadius*2).add(joyStickCenterLeft));

        draw.static.setColor("212528");
        draw.static.arc(joyStickCenterLeft, joyStickRadius-10, false);
        draw.static.arc(joyStickCenterLeft, joyStickRadius-12, false);
        draw.static.arc(joyStickCenterLeft, joyStickRadius-14, false);
        draw.static.arc(joyStickPositionLeft, joyStickRadius);

        // Left Buttons
        let buttonCenterLeft = new Point((swemu.joycon.width/2), (swemu.joycon.height/2));

        draw.static.setColor("00c3e3");
        draw.static.rect(new Point(-buttonRadius*3, -buttonRadius*3).add(buttonCenterLeft), new Point(buttonRadius*3, buttonRadius*3).add(buttonCenterLeft));

        draw.static.setColor("212528");
        draw.static.arc(new Point(0, -buttonRadius*2).add(buttonCenterLeft), buttonRadius-(gamepads.player1.pressed.dpad.up ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(buttonRadius*2, 0).add(buttonCenterLeft), buttonRadius-(gamepads.player1.pressed.dpad.right ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(0, buttonRadius*2).add(buttonCenterLeft), buttonRadius-(gamepads.player1.pressed.dpad.down ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(-buttonRadius*2, 0).add(buttonCenterLeft), buttonRadius-(gamepads.player1.pressed.dpad.left ? pressedShrinkRadius : 0));

        // Right JoyCon
        let joyStickCenterRight = new Point((swemu.joycon.width/2), (swemu.joycon.height/2)).add(points.redJoyConStart);
        let joyStickPositionRight = new Point(joyStickRadius*0.8*gamepads.player1.joystick.right.x, joyStickRadius*0.8*gamepads.player1.joystick.right.y).add(joyStickCenterRight);

        draw.static.setColor("e60012");
        draw.static.rect(new Point(-joyStickRadius*2, -joyStickRadius*2).add(joyStickCenterRight), new Point(joyStickRadius*2, joyStickRadius*2).add(joyStickCenterRight));

        draw.static.setColor("212528");
        draw.static.arc(joyStickCenterRight, joyStickRadius-10, false);
        draw.static.arc(joyStickCenterRight, joyStickRadius-12, false);
        draw.static.arc(joyStickCenterRight, joyStickRadius-14, false);
        draw.static.arc(joyStickPositionRight, joyStickRadius);

        // Right Buttons
        let buttonCenterRight = new Point((swemu.joycon.width/2), (swemu.joycon.height/4)).add(points.redJoyConStart);

        draw.static.setColor("e60012");
        draw.static.rect(new Point(-buttonRadius*3, -buttonRadius*3).add(buttonCenterRight), new Point(buttonRadius*3, buttonRadius*3).add(buttonCenterRight));

        draw.static.setColor("212528");
        draw.static.arc(new Point(0, -buttonRadius*2).add(buttonCenterRight), buttonRadius-(gamepads.player1.pressed.x ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(buttonRadius*2, 0).add(buttonCenterRight), buttonRadius-(gamepads.player1.pressed.a ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(0, buttonRadius*2).add(buttonCenterRight), buttonRadius-(gamepads.player1.pressed.b ? pressedShrinkRadius : 0));
        draw.static.arc(new Point(-buttonRadius*2, 0).add(buttonCenterRight), buttonRadius-(gamepads.player1.pressed.y ? pressedShrinkRadius : 0));

        let smaller = new Point(1, -1);
        draw.static.setColor("dadada");
        draw.static.text("X", new Point(-6, -buttonRadius*2+5).add(buttonCenterRight).add(gamepads.player1.pressed.x ? smaller : new Point()), gamepads.player1.pressed.x ? 10 : 12);
        draw.static.text("A", new Point(buttonRadius*2-5, 5).add(buttonCenterRight).add(gamepads.player1.pressed.a ? smaller : new Point()), gamepads.player1.pressed.a ? 10 : 12);
        draw.static.text("B", new Point(-5, buttonRadius*2+6).add(buttonCenterRight).add(gamepads.player1.pressed.b ? smaller : new Point()), gamepads.player1.pressed.b ? 10 : 12);
        draw.static.text("Y", new Point(-buttonRadius*2-6, 6).add(buttonCenterRight).add(gamepads.player1.pressed.y ? smaller : new Point()), gamepads.player1.pressed.y ? 10 : 12);
      }

      // Init listeners
      window.addEventListener("gamepadconnected",    event => {gamepadHandler(event, true );}, false);
      window.addEventListener("gamepaddisconnected", event => {gamepadHandler(event, false);}, false);

      // Static / One-Time render
      renderSwitch();

      let mainRenderer = () => {
        context.dynamic.clearRect(0, 0, canvas.dynamic.width, canvas.dynamic.height);

        getGamepadData();
        renderGamepad();

        if (gamepads.player1.pressed.dpad.up) {
          if (!gamepads.player1.actions.dpad.up) {
            let timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.any;
            if (gamepads.player1.actions.timeouts.dpad.up.first) {
              timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.first;
              gamepads.player1.actions.timeouts.dpad.up.first = false;
            }
            clearTimeout(gamepads.player1.actions.timeouts.dpad.up.timeout);
            gamepads.player1.actions.timeouts.dpad.up.timeout = setTimeout(() => {gamepads.player1.actions.dpad.up = false;}, timeoutDuration);
            homeScreen.dpad_up(); // Maybe this need's some parameters. Not yet tho.
          }
          gamepads.player1.actions.dpad.up = true;
        } else {
          gamepads.player1.actions.dpad.up = false;
          gamepads.player1.actions.timeouts.dpad.up.first = true;
        }

        if (gamepads.player1.pressed.dpad.down) {
          if (!gamepads.player1.actions.dpad.down) {
            let timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.any;
            if (gamepads.player1.actions.timeouts.dpad.down.first) {
              timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.first;
              gamepads.player1.actions.timeouts.dpad.down.first = false;
            }
            clearTimeout(gamepads.player1.actions.timeouts.dpad.down.timeout);
            gamepads.player1.actions.timeouts.dpad.down.timeout = setTimeout(() => {gamepads.player1.actions.dpad.down = false;}, timeoutDuration);
            homeScreen.dpad_down(); // Maybe this need's some parameters. Not yet tho.
          }
          gamepads.player1.actions.dpad.down = true;
        } else {
          gamepads.player1.actions.dpad.down = false;
          gamepads.player1.actions.timeouts.dpad.down.first = true;
        }

        if (gamepads.player1.pressed.dpad.left) {
          if (!gamepads.player1.actions.dpad.left) {
            let timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.any;
            if (gamepads.player1.actions.timeouts.dpad.left.first) {
              timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.first;
              gamepads.player1.actions.timeouts.dpad.left.first = false;
            }
            clearTimeout(gamepads.player1.actions.timeouts.dpad.left.timeout);
            gamepads.player1.actions.timeouts.dpad.left.timeout = setTimeout(() => {gamepads.player1.actions.dpad.left = false;}, timeoutDuration);
            homeScreen.dpad_left(); // Maybe this need's some parameters. Not yet tho.
          }
          gamepads.player1.actions.dpad.left = true;
        } else {
          gamepads.player1.actions.dpad.left = false;
          gamepads.player1.actions.timeouts.dpad.left.first = true;
        }

        if (gamepads.player1.pressed.dpad.right) {
          if (!gamepads.player1.actions.dpad.right) {
            let timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.any;
            if (gamepads.player1.actions.timeouts.dpad.right.first) {
              timeoutDuration = gamepads.player1.actions.timeouts.dpad.duration.first;
              gamepads.player1.actions.timeouts.dpad.right.first = false;
            }
            clearTimeout(gamepads.player1.actions.timeouts.dpad.right.timeout);
            gamepads.player1.actions.timeouts.dpad.right.timeout = setTimeout(() => {gamepads.player1.actions.dpad.right = false;}, timeoutDuration);
            homeScreen.dpad_right(); // Maybe this need's some parameters. Not yet tho.
          }
          gamepads.player1.actions.dpad.right = true;
        } else {
          gamepads.player1.actions.dpad.right = false;
          gamepads.player1.actions.timeouts.dpad.right.first = true;
        }

        if (gamepads.player1.pressed.a) {
          if (!gamepads.player1.actions.a)
            homeScreen.buttons_a();
          gamepads.player1.actions.a = true;
        } else gamepads.player1.actions.a = false;

        if (gamepads.player1.pressed.b) {
          if (!gamepads.player1.actions.b)
            homeScreen.buttons_b();
          gamepads.player1.actions.b = true;
        } else gamepads.player1.actions.b = false;

        if (gamepads.player1.pressed.x) {
          if (!gamepads.player1.actions.x)
            homeScreen.buttons_x();
          gamepads.player1.actions.x = true;
        } else gamepads.player1.actions.x = false;

        if (gamepads.player1.pressed.y) {
          if (!gamepads.player1.actions.y)
            homeScreen.buttons_y();
          gamepads.player1.actions.y = true;
        } else gamepads.player1.actions.y = false;

        if (gamepads.player1.pressed.pause) {
          if (!gamepads.player1.actions.pause)
            homeScreen.buttons_pause();
          gamepads.player1.actions.pause = true;
        } else gamepads.player1.actions.pause = false;

        homeScreen.render(draw.dynamic, gamepads, render);

        let now = Date.now();
        render.deltaTime = (now - render.now) / 1000;
        render.now = now;
        if (render.input.verbose && render.input.updated) {
          render.input.delay = Date.now() - render.input.now;
          //console.log(render.input.delay);
          if (internals.settings.debug) {
            draw.dynamic.setColor("ffffff");
            draw.dynamic.text(""+render.delayed.input.delay+"ms", new Point(10+3, swemu.screen.height-10-7), 14);
            draw.dynamic.text(""+parseInt(1/render.delayed.deltaTime)+"fps", new Point(10+3+56, swemu.screen.height-10-7), 14);
          }
          render.input.updated = false;
        }

        requestAnimationFrame(mainRenderer);
      }

      if (getCookie("settings") === null) setCookie("settings", JSON.stringify(internals.settings), 30);
      internals.settings = JSON.parse(getCookie("settings"));

      if (getCookie("users") === null) setCookie("users", JSON.stringify(internals.users), 30);
      internals.users = JSON.parse(getCookie("users"));

      if (getCookie("s-uid") === null) setCookie("s-uid", generateUID(), 30);
      internals.uid = getCookie("s-uid");

      let homeScreen = new HomeScreen(swemu);
      homeScreen.init(internals);

      if (internals.users.length === 0) {
        let settings = new Settings(swemu);
        homeScreen._currentGame = settings.init(internals);
        homeScreen._paused = true;
        homeScreen._actionClick = 0;
      }

      setInterval(() => {
        render.delayed.input.delay = render.input.delay;
        render.delayed.deltaTime = render.deltaTime;
      }, 100);

      render.now = Date.now();
      requestAnimationFrame(mainRenderer);
    </script>
  </body>
</html>
